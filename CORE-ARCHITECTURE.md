# Core Architecture - What Actually Matters

This document captures the essential components for a clean, minimal template.
Everything else in this repo is experimental/legacy.

## Essential Flow

```
/refine (Idea → Planning)
    │
    ├─→ Discovery questions (8-12)
    ├─→ docs/initial-planning/ (vision, scope, manual tasks)
    └─→ docs/finalized-plan/
          ├─ prd.md (PM agent)
          └─ architecture.md (Architect agent)

/orc-exe (Planning → Execution)
    │
    ├─→ Story Generation (SM agent)
    │     ├─ docs/stories/*.md
    │     └─ docs/sprint-artifacts/parallel-boundaries.yaml
    │
    └─→ Three-Pass Execution
          ├─ First Pass: Skeleton (functional, ugly)
          ├─ Second Pass: Polish (beautiful, validated)
          └─ Third Pass: Debug (production-ready)
```

---

## Essential Files (Keep These)

### Commands (`.claude/commands/`)
```
orc-exe.md      # Main execution orchestrator command
refine.md       # Idea pipeline command
resume.md       # Pick up where you left off
handoff.md      # Save state, push to GitHub
push-to-github.md # Quick save
```

### Agents (`.system/agents/`)
```
orc-exe.md        # Supreme orchestrator (spawns Task() sub-agents)
sm.md             # Scrum Master (creates stories from PRD)
pm.md             # Product Manager (creates PRD)
architect.md      # Architect (creates architecture.md)
dev-first-pass.md # Skeleton builder (backend-first)
dev-second-pass.md # Component polisher (UI/UX)
dev-third-pass.md  # Bug fixer (production hardening)
dev-base.md        # Shared dev behaviors (optional)
```

### Status Files (`.system/`)
```
execution-status.yaml    # Current pass, progress tracking
contracts/               # Sub-agent completion contracts (directory)
```

### Sprint Artifacts (`docs/sprint-artifacts/`)
```
sprint-status.yaml           # Story tracking
parallel-boundaries.yaml     # Chunk definitions for parallel execution
sprint-status-template.yaml  # Template
```

### Planning Output (`docs/`)
```
finalized-plan/
  ├─ prd.md          # Product Requirements
  └─ architecture.md # Technical Architecture

initial-planning/
  ├─ full-idea.md    # Vision document
  ├─ scope.md        # MVP vs backlog
  └─ manual.md       # Non-automated tasks

stories/             # Story files (generated by SM)
epics.md             # Epic definitions
```

---

## Core Concepts

### 1. Task() Spawning (NOT Terminal Prompts)
```javascript
// ORC-EXE spawns sub-agents via Task()
Task({
  description: "Story 1-1: User Authentication",
  subagent_type: "general-purpose",
  prompt: `
    You are dev-first-pass. Read .system/agents/dev-first-pass.md.
    Implement story: docs/stories/1-1-user-auth.md
    Write contract: .system/contracts/story-1-1-completion.yaml
  `
})
```

### 2. Contract-Based Coordination
Sub-agents write completion contracts:
```yaml
# .system/contracts/story-1-1-completion.yaml
story_id: "1-1"
status: completed
pass: first
tests:
  total: 12
  passed: 12
files_modified:
  - src/auth/user.js
  - tests/auth.test.js
```

### 3. Three-Pass Development
| Pass | Goal | Agent | Focus |
|------|------|-------|-------|
| First | Make it work | dev-first-pass | Backend, tests, ugly UI |
| Second | Make it beautiful | dev-second-pass | Polish, components, UX |
| Third | Make it bulletproof | dev-third-pass | Bugs, edge cases, perf |

### 4. Parallel Execution via Chunks
Stories grouped into "chunks" with dependency tracking:
```yaml
chunks:
  - id: chunk-01
    stories: ["1-1", "1-3"]  # Can run in parallel
  - id: chunk-02
    depends_on: [chunk-01]
    stories: ["1-2"]         # Waits for chunk-01
```

---

## What Can Be Deleted (Not Essential)

### Skills (`.claude/skills/orc-exe/`)
Most of these are over-engineered. For MVP, ORC-EXE can:
- Inline the logic it needs
- Use simple file reads instead of elaborate skill systems

**Potentially useful to keep (simplified):**
- `sprint-batch-analyzer.md` - Dependency analysis
- `pass-manager.md` - Pass transitions

**Likely delete:**
- `agent-selector.md` - Overkill for 5 agents
- `parallel-coordinator.md` - Complex, rarely needed
- `terminal-prompt-generator.md` - Not needed with Task()
- `contract-orchestrator.md` - Can be inlined
- `review-queue.md` - Nice to have, not essential
- Many others...

### Template/Build Logs
```
.system/template/          # Old build artifacts
.system/parallel-work/     # Old parallel tracking
.system/components/        # Unused
.system/proven/            # Unused
.system/sandbox/           # Unused
.system/validation/        # Unused
.system/notifications/     # Unused
.system/build-intelligence/ # Unused
.system/boilerplate/       # Unused
```

### Docs
```
docs/AGENTS.md              # Can be simplified
docs/COMMANDS.md            # Can be simplified
docs/PARALLEL-TESTING-GUIDE.md # Old pattern
docs/TROUBLESHOOTING.md     # Likely outdated
```

---

## Minimal Template Structure

```
project-template/
├── .claude/
│   ├── commands/
│   │   ├── orc-exe.md
│   │   ├── refine.md
│   │   ├── resume.md
│   │   └── handoff.md
│   └── config/
│       └── settings.json
│
├── .system/
│   ├── agents/
│   │   ├── orc-exe.md
│   │   ├── sm.md
│   │   ├── pm.md
│   │   ├── architect.md
│   │   ├── dev-first-pass.md
│   │   ├── dev-second-pass.md
│   │   └── dev-third-pass.md
│   ├── contracts/
│   │   └── .gitkeep
│   └── execution-status.yaml
│
├── docs/
│   ├── finalized-plan/
│   │   └── .gitkeep
│   ├── initial-planning/
│   │   └── .gitkeep
│   ├── sprint-artifacts/
│   │   └── .gitkeep
│   └── stories/
│       └── .gitkeep
│
├── next-steps.md
├── README.md
└── .mcp.json (Playwright config)
```

**Total: ~15 files** vs current ~100+ files

---

## Key Behaviors to Preserve

### ORC-EXE Must:
1. Check prerequisites (prd.md + architecture.md exist)
2. Trigger SM if no stories exist
3. Load parallel-boundaries for chunk info
4. Spawn Task() agents for stories (parallel when possible)
5. Monitor contracts for completion
6. Recommend /clear between passes
7. Display progress to operator

### Dev Agents Must:
1. Read story file completely
2. Read architecture for context
3. Implement acceptance criteria
4. Write tests
5. Validate with Playwright MCP
6. Write completion contract

### SM Must:
1. Read PRD and architecture
2. Create epics.md
3. Create stories in docs/stories/
4. Generate parallel-boundaries.yaml
5. Write sprint-status.yaml

---

## Next Steps

1. [ ] Review this document
2. [ ] Agree on what's essential vs nice-to-have
3. [ ] Create fresh minimal template
4. [ ] Test the flow end-to-end
5. [ ] Iterate based on what breaks
